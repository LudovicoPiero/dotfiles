{
  inputs,
  ...
}:
let
  inherit (inputs.nixpkgs.lib) packagesFromDirectoryRecursive;

in
{
  perSystem =
    {
      pkgs,
      system,
      ...
    }:
    let
      sources = pkgs.callPackage ../_sources/generated.nix { };
    in
    {
      _module.args.pkgs = import inputs.nixpkgs {
        inherit system;
        config.allowUnfree = true;
      };

      packages = packagesFromDirectoryRecursive {
        callPackage = pkgs.callPackage;
        directory = ./.;
      };
    };
}
